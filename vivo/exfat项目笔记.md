## 问题描述

测试同事反馈，安卓12的机器无法识别 exfat 格式的 U 盘内容，而且先插到安卓11的机器再插入 安卓12会重复创建相同文件夹。

经过排查，安卓12 使用 5.10 kernel 的机型都有此表现。

## 问题定位



什么是驱动？驱动就是 linux 内核里的文件系统代码。

老驱动：采用 github 第三方 exfat 驱动

新驱动：问题复现的设备所采用的驱动，采用内核原生的 exfat 驱动。该驱动不支持 namecase 参数。



> 使用 `mount | grep exfat` 查看已经挂载的 exfat 文件系统的参数，这个命令可以知道 exfat 挂载时用的参数。



**手机系统 在挂载设备时，会自动调用 fsck 工具，检查文件系统的一致性。**因此，首先排除工具的影响，做法：

> 将 PD2183 手机里的 fsck.exfat 等工具改名，让系统识别不到这个工具，因此就无法正常调用。

在去掉 fsck 工具后，通过命令行手动挂载 U 盘，在老驱动上分别以 namecase 为 0、1 的参数，挂载，创建文件后，插入新驱动机器。经过实验后发现：

1. 老驱动上使用 namecase = 0 参数挂载后创建的文件，在新驱动上可以正常识别。

2. 老驱动上使用 namecase = 1 参数挂载后创建的文件，在新驱动上无法正常识别。
3. 对损坏的 U 盘使用修复工具后，在新驱动上可以识别了。

**由此推测，该问题是由于安卓12用的 kernel 不支持识别 namecase 参数，识别文件 metadata 有问题，且工具能够修复文件 metadata。**



## exFAT 结构记录

- exFAT 第一块
- exFAT 的第一个簇是簇位图文件(bitmap)。在整个 exFAT 文件系统中，它是 cluster[2]。第一个是 DBR，第二个是 FAT。**这个值记录在了 DBR 的首簇起始扇区号中。**
- 