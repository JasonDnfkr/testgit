## 问题描述

测试同事反馈，安卓12的机器无法识别 exfat 格式的 U 盘内容，而且先插到安卓11的机器再插入 安卓12会重复创建相同文件夹。

经过排查，安卓12 使用 5.10 kernel 的机型都有此表现。

## 问题定位



什么是驱动？驱动就是 linux 内核里的文件系统代码。

老驱动：采用 github 第三方 exfat 驱动

新驱动：问题复现的设备所采用的驱动，采用内核原生的 exfat 驱动。该驱动不支持 namecase 参数。



> 使用 `mount | grep exfat` 查看已经挂载的 exfat 文件系统的参数，这个命令可以知道 exfat 挂载时用的参数。



**手机系统 在挂载设备时，会自动调用 fsck 工具，检查文件系统的一致性。**因此，首先排除工具的影响，做法：

> 将 PD2183 手机里的 fsck.exfat 等工具改名，让系统识别不到这个工具，因此就无法正常调用。

在去掉 fsck 工具后，通过命令行手动挂载 U 盘，在老驱动上分别以 namecase 为 0、1 的参数，挂载，创建文件后，插入新驱动机器。经过实验后发现：

1. 老驱动上使用 namecase = 0 参数挂载后创建的文件，在新驱动上可以正常识别。

2. 老驱动上使用 namecase = 1 参数挂载后创建的文件，在新驱动上无法正常识别。
3. 对损坏的 U 盘使用修复工具后，在新驱动上可以识别了。

**由此推测，该问题是由于安卓12用的 kernel 不支持识别 namecase 参数，识别文件 metadata 有问题，且工具能够修复文件 metadata。**



## exFAT 结构记录

- exFAT 的第一个簇是簇位图文件(bitmap)，第二个簇是大写字符文件，第三个簇是根目录簇。在整个 exFAT 文件系统中，簇位图文件是 cluster[2]，因为，第一个是 DBR，第二个是 FAT。**这个值（簇位图文件）记录在了 DBR 的首簇起始扇区号中。**
- 怎么定位文件：
  - 每个文件都由目录项管控，每个目录项有三条属性
  - “属性1”目录项用来记录该目录项的附属目录项数、校验和、文件属性、时间戳等信息。
  - “属性2”目录项用来记录文件是否有碎片、文件名的字符数、文件名的Hash值、**文件的起始簇号**及**大小**等信息。
  - “属性3”目录项用来具体记录文件的名称。如果文件名很长，“属性3”可以包含多个目录项，每个目录项称为一个片段。
  - **因此，定位文件时，从其父目录中找到该文件的起始簇号，然后去FAT表里查看它是否连续（FAT表相当于链表指针，连续记录了文件数据），根据连续的簇号，计算出在文件系统里的偏移即可。**